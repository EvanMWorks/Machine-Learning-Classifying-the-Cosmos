---
title: 'Classification Project Work Part 1'
author: 'Michael Kachanyuk, Evan Workss, Finn Browning'
subtitle: "DATA 252: Models and Machine Learning"
output:
  html_document: rmdformats::readthedown
  pdf_document: default
---

------------------------------------------------------------------------

```{r, message = FALSE, warning = FALSE}
# Libraries

library(tidyverse)
library(GGally)
library(class)
library(caret)
library(rpart)
library(rpart.plot)
library(ipred)
library(bestglm)

```

------------------------------------------------------------------------

# Data and Wrangling

```{r, message = FALSE}
# Data

galaxy <- read_csv("Data/galaxy.csv")
star <- read_csv("Data/star.csv")
quasar <- read_csv("Data/quasar.csv")
space <- read_csv("Data/space.csv")

# Tidy
galaxy <- na.omit(galaxy)
star <- na.omit(star)
quasar <- na.omit(quasar)
space <- na.omit(space)

# Space Quasar Galaxy
space_qg <- space %>% 
  filter(classlabel_dsc_joint != 'star')

```

------------------------------------------------------------------------

# Normalizing Data

```{r}

sd(pull(space, 1), na.rm = TRUE)
sd(pull(space, 2), na.rm = TRUE)
sd(pull(space, 3), na.rm = TRUE)
sd(pull(space, 4), na.rm = TRUE)
sd(pull(space, 5), na.rm = TRUE)
sd(pull(space, 6), na.rm = TRUE)
sd(pull(space, 7), na.rm = TRUE)
sd(pull(space, 8), na.rm = TRUE)
sd(pull(space, 9), na.rm = TRUE)
sd(pull(space, 10), na.rm = TRUE)
sd(pull(space, 11), na.rm = TRUE)
sd(pull(space, 12), na.rm = TRUE)
sd(pull(space, 13), na.rm = TRUE)
sd(pull(space, 14), na.rm = TRUE)
sd(pull(space, 15), na.rm = TRUE)
sd(pull(space, 16), na.rm = TRUE)

```

```{r}

space_S <- space
space_S[,1:16] <- scale(space_S[,1:16])
space_S <- data.frame(space_S)

```

```{r}

sd(pull(space_S, 1), na.rm = TRUE)
sd(pull(space_S, 2), na.rm = TRUE)
sd(pull(space_S, 3), na.rm = TRUE)
sd(pull(space_S, 4), na.rm = TRUE)
sd(pull(space_S, 5), na.rm = TRUE)
sd(pull(space_S, 6), na.rm = TRUE)
sd(pull(space_S, 7), na.rm = TRUE)
sd(pull(space_S, 8), na.rm = TRUE)
sd(pull(space_S, 9), na.rm = TRUE)
sd(pull(space_S, 10), na.rm = TRUE)
sd(pull(space_S, 11), na.rm = TRUE)
sd(pull(space_S, 12), na.rm = TRUE)
sd(pull(space_S, 13), na.rm = TRUE)
sd(pull(space_S, 14), na.rm = TRUE)
sd(pull(space_S, 15), na.rm = TRUE)
sd(pull(space_S, 16), na.rm = TRUE)


```

------------------------------------------------------------------------

# GGPairs Plots

```{r, message = FALSE}

# ggpairs(space_S,aes(color = classlabel_dsc_joint, alpha=0.3))

ggpairs(space_S[, c(1:3, 17)],aes(color = classlabel_dsc_joint, alpha=0.1))
ggpairs(space_S[, c(4:7, 17)],aes(color = classlabel_dsc_joint, alpha=0.1))
ggpairs(space_S[, c(8:9, 17)],aes(color = classlabel_dsc_joint, alpha=0.1))
ggpairs(space_S[, c(10:11, 17)],aes(color = classlabel_dsc_joint, alpha=0.1))
ggpairs(space_S[, c(12:14, 17)],aes(color = classlabel_dsc_joint, alpha=0.1))
ggpairs(space_S[, c(15:16, 17)],aes(color = classlabel_dsc_joint, alpha=0.1))

```

------------------------------------------------------------------------

# Identify Response Variable and Numerical Features

Response Variable:

-   'classlabel_dsc_joint'

    -   Categorical variable: 'galaxy', 'quasar', 'stars'

Numerical Variables:

-   Photometry Variables:

    -   'phot_g_mean_mag': G-band mean, 'phot_bp_mean_mag': BP-band mean, 'phot_rp_mean_mag': RP-band mean, 'bp_rp': BP minus RP color, 'bp_g': BP minus G color, 'g_rp': G minus RP color
        -   Measured in Magnitudes
    -   'pseudocolour', ''pseudocolour_error'
        -   Astrometrically estimated value expressed with μm⁻¹

-   Distance/Location Variables:

    -   'ra': Right Ascension, 'dec': Declination, 'parallax': Parallax
        -   Angle[deg]
    -   'ra_error', 'dec_error', 'parralax_error'
        -   Angle[mas]
    -   'l', 'b'
        -   Angle[deg] (Galactic Lat and Long)

------------------------------------------------------------------------

# KNN Model

## Splitting into Testing and Training

```{r}

set.seed(240)

galaxyS <- space_S%>%
  filter(classlabel_dsc_joint=="galaxy")

quasarS <- space_S%>%
  filter(classlabel_dsc_joint=="quasar")

starS <- space_S%>%
  filter(classlabel_dsc_joint=="star")

sample_sizeg <- ceiling(0.6 * nrow(galaxyS))
sample_sizeq <- ceiling(0.6 * nrow(quasarS))
sample_sizes <- ceiling(0.6 * nrow(starS))

traing <- sample(1:nrow(galaxyS), sample_sizeg)
trainq <- sample(1:nrow(quasarS), sample_sizeq)
trains <- sample(1:nrow(starS), sample_sizes)

space.train <- rbind(galaxyS[traing, ], quasarS[trainq, ], starS[trains, ])
space.test <- rbind(galaxyS[-traing, ], quasarS[-trainq, ], starS[-trains, ])

space.train$classlabel_dsc_joint <- as.factor(space.train$classlabel_dsc_joint)
space.test$classlabel_dsc_joint <- as.factor(space.test$classlabel_dsc_joint)

```

## KNN Model Correct and Error

```{r}

knn_space<- knn(train = space.train[,1:16], 
              test = space.test[,1:16], 
              cl = space.train$classlabel_dsc_joint, 
              k = 3)

## correct
KNN_correct <- mean(knn_space==space.test$classlabel_dsc_joint)
KNN_correct
## error
KNN_error <- mean(knn_space!=space.test$classlabel_dsc_joint)
KNN_error

```

## Plot K Neighborhood

```{r}

error <- rep(0,15)
for (i in 1:15) {
  knn_space<- knn(train = space.train[,1:16], test = space.test[,1:16], cl = space.train$classlabel_dsc_joint, k = i)
  error[i] = 1- mean(knn_space == space.test$classlabel_dsc_joint)
}

plot_data <- data.frame(k=1:15,error)

k_neighborhood_plot <- ggplot(data = plot_data, aes(x = k, y = error)) +
  geom_line(color = "red",linewidth = 1.05)+
  xlab("Neighborhood Size")+
  theme_bw()

k_neighborhood_plot

```

## KNN Model with optimal K value

```{r}

space_pred <- knn(train = space.train[,1:16], 
                 test = space.test[,1:16], 
                 cl = space.train$classlabel_dsc_joint, 
                 k=3)

KNN_mat <- table(space.test$classlabel_dsc_joint, space_pred)
KNN_mat

```

Model predicts the three categories fairly well with a \~93% accuracy and \~6% error. Stars seems to have the most false predictions.

------------------------------------------------------------------------

# Classification Tree

## CP Tree

```{r}

classTree<- rpart(classlabel_dsc_joint ~ .,
                  data = space.train,
                  method = "class")

### PLOT TREE
rpart.plot(classTree)

### Plot CP
plotcp(classTree)

printcp(classTree)

## WHICH CP
minCP<-classTree$cptable[which.min(classTree$cptable[,"xerror"]),"CP"]

```

## Pruning

```{r}

prune_classTree <- prune(classTree, cp = minCP )
rpart.plot(prune_classTree )

```

## Default and Pruned Tree

```{r}
## DEFAULT TREE 
### PREDICT
predTree1<-predict(classTree , space.test, type="class")

### CONFUSION MATRIX
cmTree1<-table(space.test$classlabel_dsc_joint, predTree1)
cmTree1

#### CORRECT RATE
default_correct <- mean(space.test$classlabel_dsc_joint==predTree1)
default_correct

## PRUNED TREE 
### PREDICT
predTree2<-predict(prune_classTree , space.test, type="class")

### CONFUSION MATRIX
cmTree2<-table(space.test$classlabel_dsc_joint, predTree2)
cmTree2

#### CORRECT RATE
prune_correct <- mean(space.test$classlabel_dsc_joint==predTree2)
prune_correct

```

------------------------------------------------------------------------

# Bagging

## Default Bagging

```{r}

### BAG
spaceBag <- bagging(classlabel_dsc_joint ~ .,
                   data = space.train,
                   nbagg = 150,   
                   coob = TRUE,
                   control = rpart.control(minsplit = 2, cp = 0))

## PREDICT
predBag<-predict(spaceBag, space.test, type="class")

## CONFUSION MATRIX
cmBag<-table(space.test$classlabel_dsc_joint, predBag)
cmBag

## CORRECT RATE
bag_correct <- mean(space.test$classlabel_dsc_joint==predBag)
bag_correct

```

## Caret Bagging

```{r}

caretBag <- train(classlabel_dsc_joint ~., 
               data = space.train, 
               method = "treebag",
               trControl = trainControl("cv", number = 10),
               importance = TRUE
)

predCaretBag <- caretBag %>% predict(space.test)

# CONFUSION MATRIX
table(predCaretBag, space.test$classlabel_dsc_joint)

# CORRECT RATE
mean(predCaretBag == space.test$classlabel_dsc_joint)
```

------------------------------------------------------------------------

# Logistic Regression

## Normalizing

```{r}

space_qgS <- space_qg
space_qgS[,1:16] <- scale(space_qgS[,1:16])
space_qgS <- data.frame(space_qgS)

```

```{r}

sd(pull(space_qgS, 1), na.rm = TRUE)
sd(pull(space_qgS, 2), na.rm = TRUE)
sd(pull(space_qgS, 3), na.rm = TRUE)
sd(pull(space_qgS, 4), na.rm = TRUE)
sd(pull(space_qgS, 5), na.rm = TRUE)
sd(pull(space_qgS, 6), na.rm = TRUE)
sd(pull(space_qgS, 7), na.rm = TRUE)
sd(pull(space_qgS, 8), na.rm = TRUE)
sd(pull(space_qgS, 9), na.rm = TRUE)
sd(pull(space_qgS, 10), na.rm = TRUE)
sd(pull(space_qgS, 11), na.rm = TRUE)
sd(pull(space_qgS, 12), na.rm = TRUE)
sd(pull(space_qgS, 13), na.rm = TRUE)
sd(pull(space_qgS, 14), na.rm = TRUE)
sd(pull(space_qgS, 15), na.rm = TRUE)
sd(pull(space_qgS, 16), na.rm = TRUE)


```

## Splitting into Training and Testing

```{r}

space_qgS <- space_qgS %>% 
  mutate(classlabel_dsc_joint = case_when(
    classlabel_dsc_joint == "quasar" ~ 1,
    classlabel_dsc_joint == "galaxy" ~ 0
  ))

space_qgS$classlabel_dsc_joint <- as.factor(space_qgS$classlabel_dsc_joint)

```

```{r}

galaxy_S <- space_qgS%>%
  filter(classlabel_dsc_joint== 0 )

quasar_S <- space_qgS%>%
  filter(classlabel_dsc_joint== 1)

sample_sizeg <- ceiling(0.6 * nrow(galaxy_S))
sample_sizeq <- ceiling(0.6 * nrow(quasar_S))

traing <- sample(1:nrow(galaxy_S), sample_sizeg)
trainq <- sample(1:nrow(quasar_S), sample_sizeq)

space.train <- rbind(galaxy_S[traing, ], quasar_S[trainq, ])
space.test <- rbind(galaxy_S[-traing, ], quasar_S[-trainq, ])

space.train$classlabel_dsc_joint <- as.factor(space.train$classlabel_dsc_joint)
space.test$classlabel_dsc_joint <- as.factor(space.test$classlabel_dsc_joint)

```

## Simple Logistic Model

```{r}

modSimp <- glm(classlabel_dsc_joint ~ phot_rp_mean_mag, data = space.train, family = 'binomial')
summary(modSimp)

```

```{r}

logistic_plot <- ggplot(data = space.train, aes(x = phot_rp_mean_mag, y = classlabel_dsc_joint)) +
  geom_point() +
  geom_line(aes(x = phot_rp_mean_mag, y = modSimp$fitted + 1), color = 'red', linewidth = 1.05) +
  theme_bw()

logistic_plot

```

## Interpretation of Model

```{r}

slope <- modSimp$coefficients[2]
slope

exp(slope)

```

## Prediction and Confusion Matrix with Thresholds

```{r}

pred1 <- predict(modSimp, newdata = space.test)
head(pred1)

```

```{r}

pred1R <- predict(modSimp, newdata = space.test, type = 'response')
head(pred1R)

```

```{r}

conf_mat1 <- data.frame(testOutcome=space.test$classlabel_dsc_joint == 1, predOut = pred1R> .5)
lr_mat <- table(conf_mat1$predOut, conf_mat1$testOutcome)
lr_mat

lr_correct <- mean(conf_mat1$predOut==conf_mat1$testOutcome)
lr_correct

```

```{r}

conf_mat2<-data.frame(testOutcome=space.test$classlabel_dsc_joint == 1, predOut=pred1R>.6)
lr_mat2 <- table(conf_mat2$predOut, conf_mat2$testOutcome)
lr_mat2

lr_correct2 <- mean(conf_mat2$predOut==conf_mat2$testOutcome)
lr_correct2

```

------------------------------------------------------------------------

# Multiple Logistic Regression

## Saturated Model Fitting

```{r}

modMulti<-glm(classlabel_dsc_joint ~.,
          data = space.train, family = "binomial")

summary(modMulti)

```

## Backward Selection

```{r}

step(modMulti)

```

## Forward Selection

```{r}

mod0 <- glm(classlabel_dsc_joint ~ 1, family = binomial, data = space.train)

step(mod0, scope = list(upper = modMulti, lower = mod0), 
     method = "forward")

```

## Best Subset Selection

```{r}

space_qgS$classlabel_dsc_joint <- as.numeric(space_qgS$classlabel_dsc_joint) -1
space.train$classlabel_dsc_joint <- as.numeric(space.train$classlabel_dsc_joint) -1
space.test$classlabel_dsc_joint <- as.numeric(space.test$classlabel_dsc_joint) -1

space_qgS <- space_qgS %>% 
  select(-l)

space.train <- space.train %>% 
  select(-l)

space.test <- space.test %>% 
  select(-l)

best.Xy <- space.train

bglm.AIC = bestglm(Xy = best.Xy, family = binomial, IC = "AIC", 
                   TopModels = 10)
bglm.AIC$BestModels

```

## Best Model

```{r}
# BEST MODEL:
# phot_g_mean_mag + phot_rp_mean_mag + ra_error + dec + parallax_error + pseudocolour_error + g_rp + b

modBest<-glm(classlabel_dsc_joint ~ phot_g_mean_mag + phot_rp_mean_mag + 
            ra_error + dec + parallax_error + pseudocolour_error + g_rp + b,
            data = space.train, family = "binomial")

summary(modBest)

```

## Best Model Prediction and Confusion Matrix

```{r}

predBest<-predict(modBest, newdata = space.test, type="response")

```

```{r}

## Threshold
conf_matBest<-data.frame(testOutcome=space.test$classlabel_dsc_joint == 1, predOut=predBest>.6)

## Confusion Matrix
mlr_mat <- table(conf_matBest$predOut, conf_matBest$testOutcome)
mlr_mat

## CORRECT RATE
mlr_correct <- mean(conf_matBest$predOut==conf_matBest$testOutcome)
mlr_correct

```

------------------------------------------------------------------------

# Final Model Comparison

## KNN Model

```{r}

## Confusion Matrix
KNN_mat
#         galaxy quasar  star
#  galaxy   3638     50  1231
#  quasar     23  29296   933
#  star     1403    891 32131

## CORRECT RATE
KNN_correct
#  0.9413041

```

## Classification Tree Model

```{r}

## Confusion Matrix
cmTree2
#         galaxy quasar  star
#  galaxy   2388    247  2284
#  quasar      2  27870  2380
#  star      952      0 33473

## CORRECT RATE
prune_correct
#  0.9157279

```

## Bagging Model

```{r}

## Confusion Matrix
cmBag
#         galaxy quasar  star
#  galaxy   4015     15   889
#  quasar     22  29326   904
#  star      968    436 33021

## CORRECT RATE
bag_correct
#  0.9535318
  
```

## Logistic Regression Model

```{r}

## Confusion Matrix
lr_mat2
#        FALSE  TRUE
#  FALSE  3576   989
#  TRUE   1343 29263

## CORRECT RATE
lr_correct2
#  0.9336954

```

## Best Multiple Logistic Regression Model

```{r}

## Confusion Matrix
mlr_mat
#        FALSE  TRUE
#  FALSE  4857    88
#  TRUE     62 30164

## CORRECT RATE
mlr_correct
#  0.9957351

```
The Best Multiple Logistic Regression Model gives the best accuracy with 99.57%.

```{r}

lr_mat2_df <-  as.data.frame(lr_mat2)
colnames(lr_mat2_df) <- c("Prediction", "Actual", "Freq")

lr_mat2_df$Actual <- factor(lr_mat2_df$Actual, levels = rev(levels(lr_mat2_df$Actual)))

ggplot(lr_mat2_df, aes(x = Prediction, y = Actual, fill = Freq)) +
  geom_tile(color = "white")+
  geom_text(aes(label = Freq), vjust = 1)+
  scale_fill_gradient(low = "white", high = "steelblue")+
  theme_minimal()+
  labs(title = "Confusion Matrix", x = "Predicted", y = "Actual")

```

```{r}

mlr_mat_df <- as.data.frame(mlr_mat)
colnames(mlr_mat_df) <- c("Prediction", "Actual", "Freq")

mlr_mat_df$Actual <- factor(mlr_mat_df$Actual, levels = rev(levels(mlr_mat_df$Actual)))

ggplot(mlr_mat_df, aes(x = Prediction, y = Actual, fill = Freq)) +
  geom_tile(color = "white")+
  geom_text(aes(label = Freq), vjust = 1)+
  scale_fill_gradient(low = "white", high = "steelblue")+
  theme_minimal()+
  labs(title = "Confusion Matrix", x = "Predicted", y = "Actual")


```

```{r}

ggplot(space.test, aes(x = classlabel_dsc_joint)) +
  geom_bar()

```



```{r}

ggplot(quasar_S, aes(x = g_rp, y = phot_rp_mean_mag)) +
  geom_point(color = 'red')

ggplot(galaxy_S, aes(x = g_rp, y = phot_rp_mean_mag, color = classlabel_dsc_joint)) +
  geom_point(color = 'green')

space_qgS$classlabel_dsc_joint <- as.factor(space_qgS$classlabel_dsc_joint)

ggplot(space_qgS, aes(x = g_rp, y = phot_rp_mean_mag, color = classlabel_dsc_joint)) +
  geom_point()

```

```{r}

library(MASS)
library(klaR)

space.train2 <- space.train %>% 
  dplyr::select(g_rp, classlabel_dsc_joint, phot_rp_mean_mag)

space.test2 <- space.test %>% 
  dplyr::select(g_rp, classlabel_dsc_joint, phot_rp_mean_mag)


ldaqs <- lda(classlabel_dsc_joint~., data = space.train2)
ldaqs

```

```{r}

predLDA <- ldaqs %>% predict(space.test2)
mean(predLDA$class==space.test2$classlabel_dsc_joint)
plot(ldaqs)

```

```{r}

space.train2$classlabel_dsc_joint <- as.factor(space.train2$classlabel_dsc_joint)

partimat(classlabel_dsc_joint~phot_rp_mean_mag + g_rp, data = space.train2, method = "lda")

```

```{r}

space.train2$classlabel_dsc_joint <- as.factor(space.train2$classlabel_dsc_joint)

qdaqs <- qda(classlabel_dsc_joint~., data = space.train2)
qdaqs

```

```{r}

predQDA <- qdaqs %>% predict(space.test2)

mean(predQDA$class==space.test2$classlabel_dsc_joint)

```

```{r}

partimat(classlabel_dsc_joint~phot_rp_mean_mag + g_rp, data = space.train2, method = "qda")

```





